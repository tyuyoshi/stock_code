name: Optimized Test Suite

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/test-optimized.yml'
      - '!**.md'
      - '!**/*.txt'
      - '!**/docs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/test-optimized.yml'
      - '!**.md'
      - '!**/*.txt'
      - '!**/docs/**'
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Run all tests regardless of changes'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7'

jobs:
  # Step 1: Detect what changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}
      tests: ${{ steps.filter.outputs.tests }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for changes
      uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          backend:
            - 'backend/**'
            - '!backend/**.md'
            - '!backend/**/docs/**'
          frontend:
            - 'frontend/**'
            - '!frontend/**.md'
            - '!frontend/**/docs/**'
          docker:
            - 'docker-compose.yml'
            - 'infrastructure/docker/**'
          tests:
            - 'backend/tests/**'
            - 'backend/pytest.ini'
            - 'backend/conftest.py'

  # Step 2: Backend tests (only if backend changed)
  backend-tests:
    name: Backend Tests & Quality
    needs: changes
    if: |
      needs.changes.outputs.backend == 'true' || 
      needs.changes.outputs.tests == 'true' ||
      github.event.inputs.run_all_tests == 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: stock_code_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python with cache
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: |
          backend/requirements.txt
          backend/requirements-test.txt
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run tests with coverage
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/stock_code_test
        REDIS_URL: redis://localhost:6379/1
        ENVIRONMENT: test
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing
    
    - name: Code Quality Checks
      if: success() || failure()
      working-directory: ./backend
      run: |
        echo "::group::Black Format Check"
        black --check . || true
        echo "::endgroup::"
        
        echo "::group::Flake8 Linting"
        flake8 . --max-line-length=100 --exclude=alembic,tests --exit-zero
        echo "::endgroup::"
        
        echo "::group::MyPy Type Check"
        mypy . --ignore-missing-imports || true
        echo "::endgroup::"
    
    - name: Upload coverage
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage

  # Step 3: Frontend tests (only if frontend changed)
  frontend-tests:
    name: Frontend Tests & Build
    needs: changes
    if: |
      needs.changes.outputs.frontend == 'true' ||
      github.event.inputs.run_all_tests == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: frontend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci --prefer-offline --no-audit
    
    - name: Run linting
      working-directory: ./frontend
      run: npm run lint || true
    
    - name: Run type checking
      working-directory: ./frontend
      run: npm run type-check || true
    
    - name: Run tests
      working-directory: ./frontend
      run: npm test -- --passWithNoTests || true
    
    - name: Build application
      working-directory: ./frontend
      run: npm run build

  # Step 4: Docker build (only on main branch or if docker files changed)
  docker-build:
    name: Docker Build Test
    needs: changes
    if: |
      (github.ref == 'refs/heads/main' && needs.changes.outputs.docker == 'true') ||
      github.event.inputs.run_all_tests == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./infrastructure/docker/Dockerfile.backend
        push: false
        tags: stock-code-backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build frontend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./infrastructure/docker/Dockerfile.frontend.dev
        push: false
        tags: stock-code-frontend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Step 5: Summary (always runs to show what was tested)
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [changes, backend-tests, frontend-tests, docker-build]
    if: always() && !contains(github.event.head_commit.message, '[skip ci]')
    
    steps:
    - name: Test Results Summary
      run: |
        echo "## üìä Test Suite Summary"
        echo ""
        echo "### Changes Detected:"
        echo "- Backend: ${{ needs.changes.outputs.backend == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}"
        echo "- Frontend: ${{ needs.changes.outputs.frontend == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}"
        echo "- Docker: ${{ needs.changes.outputs.docker == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}"
        echo ""
        echo "### Test Results:"
        echo "- Backend Tests: ${{ needs.backend-tests.result == 'success' && '‚úÖ Passed' || needs.backend-tests.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
        echo "- Frontend Tests: ${{ needs.frontend-tests.result == 'success' && '‚úÖ Passed' || needs.frontend-tests.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
        echo "- Docker Build: ${{ needs.docker-build.result == 'success' && '‚úÖ Passed' || needs.docker-build.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
        echo ""
        echo "### üí∞ Credits Saved:"
        if [[ "${{ needs.backend-tests.result }}" == "skipped" ]]; then
          echo "- Backend tests skipped: ~2 minutes saved"
        fi
        if [[ "${{ needs.frontend-tests.result }}" == "skipped" ]]; then
          echo "- Frontend tests skipped: ~3 minutes saved"
        fi
        if [[ "${{ needs.docker-build.result }}" == "skipped" ]]; then
          echo "- Docker build skipped: ~5 minutes saved"
        fi